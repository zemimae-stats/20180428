<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Hikaru GOTO" />


<title>ゼミ前統計分析勉強会2018 第1回</title>

<script src="notebook_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="notebook_files/bootstrap-3.3.5/css/yeti.min.css" rel="stylesheet" />
<script src="notebook_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="notebook_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="notebook_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="notebook_files/navigation-1.1/tabsets.js"></script>
<link href="notebook_files/pagedtable-1.1/css/pagedtable.css" rel="stylesheet" />
<script src="notebook_files/pagedtable-1.1/js/pagedtable.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #0000ff; } /* Keyword */
code > span.ch { color: #008080; } /* Char */
code > span.st { color: #008080; } /* String */
code > span.co { color: #008000; } /* Comment */
code > span.ot { color: #ff4000; } /* Other */
code > span.al { color: #ff0000; } /* Alert */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #008000; font-weight: bold; } /* Warning */
code > span.cn { } /* Constant */
code > span.sc { color: #008080; } /* SpecialChar */
code > span.vs { color: #008080; } /* VerbatimString */
code > span.ss { color: #008080; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { } /* Variable */
code > span.cf { color: #0000ff; } /* ControlFlow */
code > span.op { } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #ff4000; } /* Preprocessor */
code > span.do { color: #008000; } /* Documentation */
code > span.an { color: #008000; } /* Annotation */
code > span.cv { color: #008000; } /* CommentVar */
code > span.at { } /* Attribute */
code > span.in { color: #008000; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>



<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="fluid-row" id="header">



<h1 class="title toc-ignore">ゼミ前統計分析勉強会2018 第1回</h1>
<h4 class="author"><em>Hikaru GOTO</em></h4>
<h4 class="date"><em>2018年4月28日</em></h4>

</div>


<div class="section level2">
<h2>0．ライブラリの準備</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(tidyverse)
<span class="co"># インストールしていなければ，install.packages(&quot;tidyverse&quot;)</span></code></pre></div>
</div>
<div class="section level2">
<h2>1．データのインポート</h2>
<p>この操作は右上の「import Dataset」アイコンから可能。</p>
<div class="section level3">
<h3>おまじない</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">options</span>(<span class="dt">scipen=</span><span class="dv">100</span>) <span class="co"># 指数表示を避けるため</span></code></pre></div>
</div>
</div>
<div id="import" class="section level2">
<h2>2．Importしたデータをコピーしてオリジナルを保存</h2>
<p>この作業は必須ではないですが，私の場合，データをこねくり回しても元に戻せるようにバックアップを取ることが多いです。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d =<span class="st"> </span>titanic_data</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(d)</code></pre></div>
<div data-pagedtable="false">
<script data-pagedtable-source type="application/json">
{"columns":[{"label":["name"],"name":[1],"type":["chr"],"align":["left"]},{"label":["survived"],"name":[2],"type":["dbl"],"align":["right"]},{"label":["gender"],"name":[3],"type":["chr"],"align":["left"]},{"label":["age"],"name":[4],"type":["chr"],"align":["left"]},{"label":["passengerClass"],"name":[5],"type":["chr"],"align":["left"]}],"data":[{"1":"Allen, Miss. Elisabeth Walton","2":"1","3":"female","4":"29","5":"1st"},{"1":"Allison, Master. Hudson Trevor","2":"1","3":"male","4":"0.9","5":"1st"},{"1":"Allison, Miss. Helen Loraine","2":"0","3":"female","4":"2","5":"1st"},{"1":"Allison, Mr. Hudson Joshua Crei","2":"0","3":"male","4":"30","5":"1st"},{"1":"Allison, Mrs. Hudson J C (Bessi","2":"0","3":"female","4":"25","5":"1st"},{"1":"Anderson, Mr. Harry","2":"1","3":"male","4":"48","5":"1st"}],"options":{"columns":{"min":{},"max":[10]},"rows":{"min":[10],"max":[10]},"pages":{}}}
  </script>
</div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(d)</code></pre></div>
<pre><code>##      name              survived        gender              age           
##  Length:1309        Min.   :0.000   Length:1309        Length:1309       
##  Class :character   1st Qu.:0.000   Class :character   Class :character  
##  Mode  :character   Median :0.000   Mode  :character   Mode  :character  
##                     Mean   :0.382                                        
##                     3rd Qu.:1.000                                        
##                     Max.   :1.000                                        
##  passengerClass    
##  Length:1309       
##  Class :character  
##  Mode  :character  
##                    
##                    
## </code></pre>
</div>
<div class="section level2">
<h2>3．データの構造を見る</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(d)</code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    1309 obs. of  5 variables:
##  $ name          : chr  &quot;Allen, Miss. Elisabeth Walton&quot; &quot;Allison, Master. Hudson Trevor&quot; &quot;Allison, Miss. Helen Loraine&quot; &quot;Allison, Mr. Hudson Joshua Crei&quot; ...
##  $ survived      : num  1 1 0 0 0 1 1 0 1 0 ...
##  $ gender        : chr  &quot;female&quot; &quot;male&quot; &quot;female&quot; &quot;male&quot; ...
##  $ age           : chr  &quot;29&quot; &quot;0.9&quot; &quot;2&quot; &quot;30&quot; ...
##  $ passengerClass: chr  &quot;1st&quot; &quot;1st&quot; &quot;1st&quot; &quot;1st&quot; ...</code></pre>
</div>
<div class="section level2">
<h2>4．必要な説明変数を因子化などの変換</h2>
<p>文字列のデータはそのまま分析できません。そのため数値として扱えるように，因子化します。<code>age</code>は数値型に<code>as.numeric()</code>を使って変換します。因子化は，<code>as.factor</code>もしくは<code>factor()</code>関数を使います。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d<span class="op">$</span>survived =<span class="st"> </span><span class="kw">as.factor</span>(d<span class="op">$</span>survived)
d<span class="op">$</span>gender =<span class="st"> </span><span class="kw">as.factor</span>(d<span class="op">$</span>gender)
d<span class="op">$</span>age =<span class="st"> </span><span class="kw">as.numeric</span>(d<span class="op">$</span>age)
d<span class="op">$</span>passengerClass =<span class="st"> </span><span class="kw">as.factor</span>(d<span class="op">$</span>passengerClass)</code></pre></div>
<p>変換できたか，念のためチェックします。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">str</span>(d) <span class="co"># ちゃんと変換できたかチェック</span></code></pre></div>
<pre><code>## Classes &#39;tbl_df&#39;, &#39;tbl&#39; and &#39;data.frame&#39;:    1309 obs. of  5 variables:
##  $ name          : chr  &quot;Allen, Miss. Elisabeth Walton&quot; &quot;Allison, Master. Hudson Trevor&quot; &quot;Allison, Miss. Helen Loraine&quot; &quot;Allison, Mr. Hudson Joshua Crei&quot; ...
##  $ survived      : Factor w/ 2 levels &quot;0&quot;,&quot;1&quot;: 2 2 1 1 1 2 2 1 2 1 ...
##  $ gender        : Factor w/ 2 levels &quot;female&quot;,&quot;male&quot;: 1 2 1 2 1 2 1 2 1 2 ...
##  $ age           : num  29 0.9 2 30 25 48 63 39 53 71 ...
##  $ passengerClass: Factor w/ 3 levels &quot;1st&quot;,&quot;2nd&quot;,&quot;3rd&quot;: 1 1 1 1 1 1 1 1 1 1 ...</code></pre>
<p>要約統計量も見てみましょう。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(d)</code></pre></div>
<pre><code>##      name           survived    gender         age          passengerClass
##  Length:1309        0:809    female:466   Min.   : 0.1667   1st:323       
##  Class :character   1:500    male  :843   1st Qu.:21.0000   2nd:277       
##  Mode  :character                         Median :28.0000   3rd:709       
##                                           Mean   :29.8811                 
##                                           3rd Qu.:39.0000                 
##                                           Max.   :80.0000                 
##                                           NA&#39;s   :263</code></pre>
</div>
<div class="section level2">
<h2>5．ロジスティック回帰</h2>
<p>少し可視化しておきます。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>passengerClass)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>survived), <span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>()</code></pre></div>
<p><img src="notebook_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>gender)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_bar</span>(<span class="kw">aes</span>(<span class="dt">fill=</span>(survived)), <span class="dt">position=</span><span class="st">&quot;fill&quot;</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw">coord_flip</span>()</code></pre></div>
<p><img src="notebook_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>age, <span class="dt">y=</span>survived)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_jitter</span>(<span class="kw">aes</span>(<span class="dt">color=</span>survived)) </code></pre></div>
<p><img src="notebook_files/figure-html/unnamed-chunk-13-1.png" width="672" /></p>
<p>ちょっとイマイチの図ですが･･･。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>gender, <span class="dt">y=</span>survived)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_jitter</span>()</code></pre></div>
<p><img src="notebook_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">d <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x=</span>passengerClass, <span class="dt">y=</span>survived)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_jitter</span>()</code></pre></div>
<p><img src="notebook_files/figure-html/unnamed-chunk-15-1.png" width="672" /></p>
<p>ロジスティック回帰は<code>glm()</code>を使います。分布族に二項分布<code>family=binomial</code>を指定するのがポイントです。分析結果を<code>kekka</code>というオブジェクトに保存します。名前は好きにつけていいです。</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kekka =<span class="st"> </span><span class="kw">glm</span>(survived <span class="op">~</span><span class="st"> </span>gender <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>passengerClass, <span class="dt">data=</span>d, <span class="dt">family=</span>binomial)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(kekka)</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = survived ~ gender + age + passengerClass, family = binomial, 
##     data = d)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.6399  -0.6979  -0.4336   0.6688   2.3964  
## 
## Coefficients:
##                    Estimate Std. Error z value             Pr(&gt;|z|)    
## (Intercept)        3.522072   0.326701  10.781 &lt; 0.0000000000000002 ***
## gendermale        -2.497845   0.166037 -15.044 &lt; 0.0000000000000002 ***
## age               -0.034393   0.006331  -5.433         0.0000000556 ***
## passengerClass2nd -1.280567   0.225538  -5.678         0.0000000136 ***
## passengerClass3rd -2.289658   0.225802 -10.140 &lt; 0.0000000000000002 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1414.62  on 1045  degrees of freedom
## Residual deviance:  982.45  on 1041  degrees of freedom
##   (263 observations deleted due to missingness)
## AIC: 992.45
## 
## Number of Fisher Scoring iterations: 4</code></pre>
<p>分析結果が出たところで，オッズ比を確認してみましょう。</p>
</div>
<div class="section level2">
<h2>6．オッズ比を確認</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">exp</span>(<span class="kw">coef</span>(kekka)) <span class="co">#オッズ比</span></code></pre></div>
<pre><code>##       (Intercept)        gendermale               age passengerClass2nd 
##       33.85451255        0.08226204        0.96619149        0.27787957 
## passengerClass3rd 
##        0.10130106</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">exp</span>(<span class="kw">confint</span>(kekka)) <span class="co">#オッズ比の95%信頼区間</span></code></pre></div>
<pre><code>##                         2.5 %     97.5 %
## (Intercept)       18.11476901 65.2742374
## gendermale         0.05906837  0.1133111
## age                0.95410524  0.9781054
## passengerClass2nd  0.17763462  0.4303931
## passengerClass3rd  0.06453117  0.1565290</code></pre>
</div>
<div class="section level2">
<h2>7．もちろん交互作用も検討できる。</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">kekka_kougo =<span class="st"> </span><span class="kw">glm</span>(survived <span class="op">~</span><span class="st"> </span>gender <span class="op">+</span><span class="st"> </span>age <span class="op">+</span><span class="st"> </span>passengerClass <span class="op">+</span><span class="st"> </span>
<span class="st">                    </span>gender<span class="op">:</span>age <span class="op">+</span><span class="st"> </span>gender<span class="op">:</span>passengerClass <span class="op">+</span><span class="st"> </span>age<span class="op">:</span>passengerClass,
                    <span class="dt">data=</span>d, <span class="dt">family=</span>binomial)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">summary</span>(kekka_kougo)</code></pre></div>
<pre><code>## 
## Call:
## glm(formula = survived ~ gender + age + passengerClass + gender:age + 
##     gender:passengerClass + age:passengerClass, family = binomial, 
##     data = d)
## 
## Deviance Residuals: 
##     Min       1Q   Median       3Q      Max  
## -2.6138  -0.6754  -0.4435   0.3772   3.2448  
## 
## Coefficients:
##                               Estimate Std. Error z value  Pr(&gt;|z|)    
## (Intercept)                   3.390357   0.805278   4.210 0.0000255 ***
## gendermale                   -2.592236   0.753573  -3.440  0.000582 ***
## age                          -0.003950   0.017574  -0.225  0.822155    
## passengerClass2nd             0.764664   0.959841   0.797  0.425650    
## passengerClass3rd            -3.270004   0.764820  -4.276 0.0000191 ***
## gendermale:age               -0.031378   0.015117  -2.076  0.037929 *  
## gendermale:passengerClass2nd -0.878837   0.689942  -1.274  0.202740    
## gendermale:passengerClass3rd  1.885699   0.584625   3.225  0.001258 ** 
## age:passengerClass2nd        -0.060530   0.021420  -2.826  0.004714 ** 
## age:passengerClass3rd        -0.006244   0.016188  -0.386  0.699711    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1414.62  on 1045  degrees of freedom
## Residual deviance:  917.84  on 1036  degrees of freedom
##   (263 observations deleted due to missingness)
## AIC: 937.84
## 
## Number of Fisher Scoring iterations: 5</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#各自確かめてください。</span>
<span class="kw">exp</span>(<span class="kw">coef</span>(kekka_kougo)) <span class="co"># オッズ比</span>
<span class="kw">exp</span>(<span class="kw">confint</span>(kekka_kougo)) <span class="co"># 95%信頼区間</span></code></pre></div>
</div>
<div class="section level2">
<h2>8．別の方法でオッズ比を確認</h2>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># install.packages(&quot;epiDisplay&quot;) # インストールしてなければインストールする</span>
<span class="kw">library</span>(epiDisplay) <span class="co"># 使えるようにロードする</span>
<span class="kw">logistic.display</span>(kekka) <span class="co"># オッズ比を確認</span></code></pre></div>
<pre><code>## 
## Logistic regression predicting survived : 1 vs 0 
##  
##                          crude OR(95%CI)   adj. OR(95%CI)   
## gender: male vs female   0.08 (0.06,0.11)  0.08 (0.06,0.11) 
##                                                             
## age (cont. var.)         0.99 (0.98,1)     0.97 (0.95,0.98) 
##                                                             
## passengerClass: ref.=1st                                    
##    2nd                   0.45 (0.32,0.63)  0.28 (0.18,0.43) 
##    3rd                   0.2 (0.15,0.28)   0.1 (0.07,0.16)  
##                                                             
##                          P(Wald&#39;s test) P(LR-test)
## gender: male vs female   &lt; 0.001        &lt; 0.001   
##                                                   
## age (cont. var.)         &lt; 0.001        &lt; 0.001   
##                                                   
## passengerClass: ref.=1st                &lt; 0.001   
##    2nd                   &lt; 0.001                  
##    3rd                   &lt; 0.001                  
##                                                   
## Log-likelihood = -491.2264
## No. of observations = 1046
## AIC value = 992.4528</code></pre>
<div class="section level3">
<h3>参考文献</h3>
<p>↓はロジスティック回帰オッズ比と信頼区間の出し方を解説されています。</p>
<p><a href="https://researchmap.jp/jomk5xr2p-1781589/" class="uri">https://researchmap.jp/jomk5xr2p-1781589/</a></p>
<p>↓はこのHTML文書にある表の作成で参考にしました。</p>
<p><a href="http://yoshi-nishikawa.hatenablog.com/entry/2018/03/21/234347" class="uri">http://yoshi-nishikawa.hatenablog.com/entry/2018/03/21/234347</a></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
